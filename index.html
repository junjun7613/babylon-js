<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Babylon Template</title>
    <style>
        html,
        body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://preview.babylonjs.com/babylon.js"></script>
    <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://code.jquery.com/pep/0.4.3/pep.js"></script>
</head>

<body>

    <div id="holder"><canvas id="renderCanvas" touch-action="none"></canvas></div>
    <!-- touch-action="none" for best results from PEP -->
    <div id="instructions">
    </div>
    <style>
        #holder {
            width: 70%;
            height: 100%;
            float: left;
        }

        #instructions {
            width: 30%;
            height: 100%;
            float: left;
            text-align: center;
            background-color: white;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="objectData.js"></script>
    <!--<script src="UTDiningData.js"></script>-->
    <script>
        const canvas = document.getElementById("renderCanvas"); // Get the canvas element
        const engine = new BABYLON.Engine(canvas, true); // Generate the BABYLON 3D engine


        console.log(objectData)


        // Add your code here matching the playground format
        const createScene = function () {
            const scene = new BABYLON.Scene(engine);
            scene.enablePhysics();

            /**** Set camera and light *****/
            //const camera = new BABYLON.ArcRotateCamera("camera", -Math.PI / 2, Math.PI / 2.5, 15, new BABYLON.Vector3(0, 0, 0));
            //const camera = new BABYLON.UniversalCamera("camera", new BABYLON.Vector3(-10, 7, -15));
            const camera = new BABYLON.FreeCamera("camera", new BABYLON.Vector3(0, 2, -20));
            //camera.setTarget(BABYLON.Vector3.Zero());
            camera.attachControl(canvas, true);
            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(1, 1, 0));
            light.intensity = 1.5;

            const listMeshes = []
            listMeshes.push("aaa")

            for (let i = 0; i < objectData.length; i++) {

                BABYLON.SceneLoader.ImportMeshAsync("", "inscription1/", objectData[i].url).
                    //BABYLON.SceneLoader.ImportMeshAsync("", "https://jo-fil-ho.com/babylonJS/", objectData[i].url).
                    then(function (result) {
                        //object全体の位置を決定
                        object = result.meshes[0]
                        object.position.y = objectData[i].objectPosition.y;
                        object.position.x = objectData[i].objectPosition.x;
                        object.position.z = objectData[i].objectPosition.z;
                        if (objectData[i].objectRotation.x !== 0) {
                            object.rotate(BABYLON.Axis.X, Math.PI / objectData[i].objectRotation.x, BABYLON.Space.WORLD);
                        }
                        if (objectData[i].objectRotation.y !== 0) {
                            object.rotate(BABYLON.Axis.Y, Math.PI / objectData[i].objectRotation.y, BABYLON.Space.WORLD);
                        }
                        if (objectData[i].objectRotation.z !== 0) {
                            object.rotate(BABYLON.Axis.Z, Math.PI / objectData[i].objectRotation.z, BABYLON.Space.WORLD);
                        }

                        //inscription1.addBehavior(new BABYLON.PointerDragBehavior());
                        //inscription1.addRotation(x1,0,0);

                        //ここからメッシュごとの処理
                        for (const k = 0; k < scene.meshes.length; k++) {

                            //mesh = scene.meshes[k]
                            //mesh = objectData[i].meshes[k]
                            //console.log(mesh)
                            //listMeshes.push(mesh)
                            //mesh_list.push(objectData[i].meshes[k])

                            //const planePositions = [{x:-9.98,y:0.55,z:-0.37},{x:-9.98,y:0.45,z:-0.37},{x:-9.98,y:0.35,z:-0.37},{x:-9.98,y:0.25,z:-0.37}]
                            const objectPosition = objectData[i].objectPosition

                            const meshData = objectData[i].meshes[k]

                            const meshName = objectData[i].meshes[k].meshName

                            const meshType = objectData[i].meshes[k].type

                            const planePositions = objectData[i].meshes[k].textPlane.textPlanePosition

                            const textFont = objectData[i].meshes[k].textPlane.textFont

                            const transcriptions = objectData[i].meshes[k].transcriptions

                            const annotation = objectData[i].meshes[k].annotation

                            const detailCardPosition = objectData[i].meshes[k].detailCardPosition

                            const metaData = objectData[i].meshes[k].metaData

                            const data = objectData[i].meshes[k].metaData.items

                            //sceneから、データのmeshNameに一致するメッシュデータを取得
                            meshDict = {}

                            mesh = scene.getMeshByName(meshName)
                            console.log(mesh)
                            meshDict.meshOrig = meshData
                            meshDict.meshScene = mesh
                            listMeshes.push(meshDict)

                            //メッシュの元のマテリアルを取得
                            origMaterial = mesh.material
                            console.log(origMaterial)

                            //デフォルトとして色付けを行う
                            const meshMaterial = new BABYLON.StandardMaterial("material", scene);
                            if (meshType === "A") {
                                meshMaterial.diffuseColor = new BABYLON.Color3(255, 0, 0);
                                meshMaterial.alpha = 0.5;
                            } else if (meshType === "B") {
                                meshMaterial.diffuseColor = new BABYLON.Color3(0, 255, 0);
                                meshMaterial.alpha = 0.5;
                            } else {
                                meshMaterial.diffuseColor = new BABYLON.Color3(255, 255, 0);
                                meshMaterial.alpha = 0.5;
                            };
                            mesh.material = meshMaterial;
                            //元のマテリアルを設定
                            //mesh.material = origMaterial;
                            

                            for (const transcription of transcriptions) {

                                const textData_list = []

                                const texts = transcription.texts

                                for (const tx of texts) {

                                    const textData = function () {
                                        // inscription1.position.x -= 0.05;

                                        const mesh_list = []

                                        // Set font type
                                        var font_type = "Arial";

                                        // Set width an height for plane
                                        var planeWidth = 5;
                                        //var planeWidth =15;
                                        var planeHeight = 0.5;
                                        //var planeHeight = 1.5;

                                        for (let i = 0; i < tx.text.length; i++) {
                                            console.log(tx.text[i]);

                                            var plane = BABYLON.MeshBuilder.CreatePlane("plane", { width: planeWidth, height: planeHeight }, scene);
                                            //plane.position.y = planePositions[i].y;
                                            plane.position.y = objectPosition.y + planePositions[i].y;
                                            //plane.position.x = planePositions[i].x;
                                            plane.position.x = objectPosition.x + planePositions[i].x;
                                            //plane.position.z = planePositions[i].z;
                                            plane.position.z = objectPosition.z + planePositions[i].z;
                                            //plane.scaling = new BABYLON.Vector3(0.1,0.1,0.1);
                                            plane.scaling = new BABYLON.Vector3(0.1, 0.1, 0.1);
                                            console.log(planePositions[i].rotation.y)
                                            if (planePositions[i].rotation.y !== 0) {
                                                //plane.rotate(BABYLON.Axis.Y,Math.PI / planePositions[i].rotation.y, BABYLON.Space.WORLD)
                                                plane.rotate(BABYLON.Axis.Y, planePositions[i].rotation.y * Math.PI / 180, BABYLON.Space.WORLD)
                                            }
                                            plane.setParent(mesh);

                                            var DTWidth = planeWidth * 60;
                                            var DTHeight = planeHeight * 60;

                                            var text = tx.text[i];

                                            var dynamicTexture = new BABYLON.DynamicTexture("DynamicTexture", { width: DTWidth, height: DTHeight }, scene);

                                            // Check width of text for given font type at any size of font
                                            var ctx = dynamicTexture.getContext();
                                            var size = 12; //any value will work
                                            ctx.font = size + "px " + font_type;
                                            var textWidth = ctx.measureText(text).width;

                                            // Calculate ratio of text width to size of font used
                                            var ratio = textWidth / size;

                                            // set font to be actually used to write text on dynamic texture
                                            // var font_size = Math.floor(DTWidth / (ratio * 1)); //size of multiplier (1) can be adjusted, increase for smaller text
                                            //var font_size = 16
                                            var font_size = textFont
                                            var font = font_size + "px " + font_type;

                                            // Draw text
                                            dynamicTexture.drawText(text, null, null, font, "#000000", "transparent", true);

                                            var mat = new BABYLON.StandardMaterial("mat", scene);
                                            mat.diffuseTexture = dynamicTexture;
                                            mat.diffuseTexture.hasAlpha = true;

                                            // apply material
                                            plane.material = mat;

                                            plane.isVisible = false;

                                            mesh_list.push(plane)

                                        }

                                        return mesh_list;

                                    };

                                    const text_list = textData()
                                    console.log(text_list)

                                    var makeCard = function (title, positionObject) {

                                        //eval('const card_' + number + ' = BABYLON.MeshBuilder.CreateBox("box", { height: 3, width: 2, depth: 0.2 });');
                                        let card = BABYLON.MeshBuilder.CreateBox(transcription.lang, { height: 1, width: 2, depth: 0.2 });
                                        //card.position = new BABYLON.Vector3(positionObject.x, positionObject.y, positionObject.z);
                                        card.position = new BABYLON.Vector3(objectPosition.x + positionObject.x, objectPosition.y + positionObject.y, objectPosition.z + positionObject.z);
                                        card.scaling.x = 0.1;
                                        card.scaling.y = 0.1;
                                        //card.scaling.y = 0.5;
                                        card.scaling.z = 0.05;
                                        card.rotation = new BABYLON.Vector3(0, -0.5, 0);
                                        card.setParent(mesh)
                                        let plane = BABYLON.MeshBuilder.CreatePlane("plane", { height: 1, width: 2 });
                                        plane.parent = card;
                                        plane.position.z = -0.11;

                                        var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateForMesh(plane);

                                        let panel = new BABYLON.GUI.StackPanel();
                                        panel.verticalAlignment = 0;

                                        advancedTexture.addControl(panel);

                                        let ttl = new BABYLON.GUI.TextBlock(tx.title);
                                        ttl.text = tx.title;
                                        ttl.color = "black";
                                        ttl.fontSize = 150;
                                        ttl.height = "200px";
                                        ttl.textHorizontalAlignment = 0;
                                        ttl.textVerticalAlignment = 0;
                                        ttl.paddingTop = "5%";
                                        ttl.paddingButtom = 2;
                                        ttl.paddingLeft = 40;
                                        ttl.paddingRight = 40;
                                        panel.addControl(ttl);
                                        advancedTexture.addControl(ttl);

                                        let date = new BABYLON.GUI.TextBlock();
                                        date.text = tx.year;
                                        date.color = "black";
                                        date.fontSize = 120;
                                        date.height = "200px";
                                        date.textHorizontalAlignment = 0;
                                        date.textVerticalAlignment = 0;
                                        date.paddingTop = "5%";
                                        date.paddingLeft = 40;
                                        date.paddingRight = 40;
                                        panel.addControl(date);
                                        advancedTexture.addControl(date);

                                        let note = new BABYLON.GUI.TextBlock();
                                        note.fontFamily = "Tahoma, sans-serif";
                                        note.text = tx.author;
                                        note.textWrapping = true;
                                        note.color = "black";
                                        note.fontSize = 120;
                                        note.height = "200px";
                                        note.textHorizontalAlignment = 0;
                                        note.textVerticalAlignment = 0;
                                        note.paddingTop = "5%";
                                        note.paddingLeft = 40;
                                        note.paddingRight = 40;
                                        panel.addControl(note);
                                        advancedTexture.addControl(note);

                                        let button1 = BABYLON.GUI.Button.CreateSimpleButton("but1", "Show text");
                                        button1.width = 1;
                                        button1.height = "200px";
                                        button1.color = "white";
                                        button1.fontSize = 150;
                                        button1.background = "green";
                                        button1.paddingTop = "1%";
                                        button1.paddingLeft = 40;
                                        button1.paddingRight = 40;
                                        button1.paddingButtom = "5%";
                                        button1.onPointerUpObservable.add(function () {
                                            //alert("you did it!");

                                            for (const txt of text_list) {

                                                console.log(txt)

                                                if (txt.isVisible == false) {
                                                    txt.isVisible = true;
                                                } else {
                                                    txt.isVisible = false;
                                                }
                                            }
                                        });
                                        button1.verticalAlignment = 1;
                                        advancedTexture.addControl(button1);

                                        card.isVisible = false;
                                        plane.isVisible = false;
                                        ttl.isVisible = false;
                                        date.isVisible = false;
                                        note.isVisible = false;
                                        panel.isVisible = false;
                                        button1.isVisible = false;

                                        return [card, plane, ttl, date, note, panel, button1];
                                        //return [card,title,date,panel,button1];


                                    }

                                    const showCards = makeCard(tx.title, tx.positionObject)
                                    textData_list.push(showCards)


                                };

                                console.log(textData_list)

                                var button = BABYLON.MeshBuilder.CreateCylinder("button", { radius: 0.5, height: 0.2 }, scene)
                                //button_1.position.y = 0.35;
                                //button.position.y = transcription.button.buttonPosition.y;
                                button.position.y = objectPosition.y + transcription.button.buttonPosition.y;
                                button.position.x = objectPosition.x + transcription.button.buttonPosition.x;
                                button.position.z = objectPosition.z + transcription.button.buttonPosition.z;
                                button.scaling.y = 0.05;
                                button.scaling.x = 0.05;
                                button.scaling.z = 0.05;
                                button.rotation.y = Math.PI / 1;
                                button.rotation.x = Math.PI / -2;
                                button.rotation.z = Math.PI / 1;
                                button.setParent(mesh)

                                button.material = new BABYLON.StandardMaterial("mat_button", scene);
                                button.material.diffuseTexture = new BABYLON.Texture(transcription.button.buttonImage);
                                //button.material.diffuseTexture = new BABYLON.Texture("./textures/french.png");
                                //button_1.material.diffuseTexture = new BABYLON.Texture("https://jo-fil-ho.com/babylonJS/french.png");

                                // add actionManager on each cyl
                                button.actionManager = new BABYLON.ActionManager(scene);
                                // register 'pickCylinder' as the handler function for cylinder picking action.
                                button.actionManager.registerAction(
                                    new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickTrigger, function () {
                                        for (const textData of textData_list) {

                                            console.log(textData[0].name)

                                            for (const showCard of textData) {
                                                console.log(showCard)
                                                console.log(showCard.name)
                                                if (showCard.isVisible == false) {
                                                    showCard.isVisible = true;
                                                    textData[1].position.z = -0.12;
                                                    //showCard.position.z = planePositions[0].z-0.1;
                                                } else {
                                                    showCard.isVisible = false;
                                                    textData[1].position.z = -0.11;
                                                    //textData[0].position.z = objectPosition.z + positionObject.z;
                                                    //showCard.position.z = planePositions[0].z;
                                                }
                                            }
                                        }
                                    })
                                );
                            }

                            const anno_list = []

                            for (const anno of annotation) {

                                const anno_map = {}
                                anno_map.position = anno.position;
                                anno_map.scale = anno.scale;

                                console.log(anno.contentImage.length)
                                console.log(anno.position.x)

                                var font_type = "Arial";
                                //const planeWidth = 2;
                                const planeWidth = anno.scale.y * 40;
                                //const planeHeight = 2;
                                const planeHeight = anno.scale.y * 40;


                                //視点に追随するviewerを表示する場合

                                var advancedTextureDetail = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");


                                var sv = new BABYLON.GUI.ScrollViewer();
                                sv.thickness = 2;
                                sv.color = "black";
                                sv.height = 0.2;
                                sv.width = 0.6;
                                sv.background = "white";
                                sv.isVisible = false;

                                advancedTextureDetail.addControl(sv);

                                var tb = new BABYLON.GUI.TextBlock();
                                //tb.textWrapping = true;
                                tb.textWrapping = BABYLON.GUI.TextWrapping.WordWrap;
                                tb.resizeToFit = true;
                                //tb.height = 2;
                                //tb.width = 2;
                                tb.paddingTop = "1%";
                                tb.paddingLeft = "10px";
                                tb.paddingRight = "20%"
                                tb.paddingBottom = "1%";
                                //tb.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
                                //tb.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_CENTER;
                                //tb.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
                                //tb.textVerticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_CENTER;
                                tb.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
                                tb.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
                                tb.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
                                tb.textVerticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
                                tb.color = "black";
                                //tb.isVisible = false;

                                tb.text = anno.note;
                                //tb.text = "TEXT START Lorem ipsum dolor sit amet, postea petentium et eum."

                                //tb.fontSize = anno.scale.y * 1500
                                //tb.fontSize = planeHeight * 30
                                tb.fontSize = 16


                                //テスト、イメージを含むsv構築
                                var makeSVImage = function () {
                                    var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");

                                    var SVImgae = new BABYLON.GUI.ScrollViewer();
                                    SVImgae.width = "800px";
                                    SVImgae.height = "500px";
                                    SVImgae.background = "white";
                                    SVImgae.isVisible = false;

                                    advancedTexture.addControl(SVImgae);

                                    var gd = new BABYLON.GUI.Grid();
                                    gd.width = "600px";
                                    console.log(anno.contentImage.length)

                                    const rowNumber = anno.contentImage.length + 1;

                                    //console.log(rowNumber)
                                    gd.height = String(rowNumber * 300) + "px";
                                    gd.paddingTop = "15%";
                                    //gd.addColumnDefinition(1 / 3);
                                    //gd.addColumnDefinition(1 / 3);
                                    //gd.addColumnDefinition(1 / 3);
                                    gd.addColumnDefinition(3 / 4);
                                    gd.addColumnDefinition(1 / 4);
                                    /*
                                    for (let i = 0; i < parseInt((anno.contentImage.length + 1) / 3) + 1; i++) {
                                        console.log(parseInt((anno.contentImage.length + 1) / 3) + 1)
                                        gd.addRowDefinition(1 / (parseInt((anno.contentImage.length + 1) / 3) + 1));
                                    };
                                    */

                                    if (anno.contentImage.length !== 0) {
                                        for (let i = 0; i < anno.contentImage.length + 1; i++) {
                                            gd.addRowDefinition(1 / anno.contentImage.length + 1);
                                        };
                                    } else {
                                        gd.addRowDefinition(1 / 1);
                                    };


                                    SVImgae.addControl(gd);

                                    let backButton = BABYLON.GUI.Button.CreateSimpleButton("but1", "Back");
                                    backButton.width = "100px";
                                    backButton.height = "50px";
                                    backButton.color = "black";
                                    backButton.background = "black";
                                    //button1.paddingLeft = "90%";
                                    backButton.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
                                    backButton.color = "white";
                                    backButton.fontSize = 16;
                                    backButton.onPointerUpObservable.add(function () {
                                        //alert("you did it!");
                                        console.log(gd)
                                        if (SVImage.isVisible == false) {
                                            SVImage.isVisible = true;
                                        } else {
                                            SVImage.isVisible = false;
                                        }
                                        /*
                                        if (sv.isVisible == false) {
                                            sv.isVisible = true;
                                        } else {
                                            sv.isVisible = false;
                                        }
                                        */
                                    });
                                    gd.addControl(backButton, 0, 0)

                                    if (anno.contentImage.length !== 0) {
                                        
                                        for (const [index, value] of anno.contentImage.entries()) {
                                            console.log([index, value])

                                            var image = new BABYLON.GUI.Image("but", value["item"]);
                                            //image.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
                                            image.width = 0.9;
                                            image.height = 0.9;
                                            //image.populateNinePatchSlicesFromImage = true;
                                            //image.stretch = BABYLON.GUI.Image.STRETCH_NINE_PATCH;
                                            image.stretch = BABYLON.GUI.Image.STRETCH_UNIFORM;

                                            var text = new BABYLON.GUI.TextBlock();
                                            text.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
                                            text.text = "Hello!";

                                            gd.addControl(image, index + 1, 0);
                                            gd.addControl(text, index + 1, 1);
                                            console.log(index + 1);

                                        }
                                    } else {
                                        var text = new BABYLON.GUI.TextBlock();
                                        text.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
                                        text.text = "No Image!";
                                        gd.addControl(text, 0, 1)
                                    };

                                    return SVImgae;
                                };

                                const SVImage = makeSVImage()
                                console.log(SVImage)

                                let imageButton = BABYLON.GUI.Button.CreateSimpleButton("but1", "Image");
                                imageButton.width = 0.3;
                                imageButton.height = "50px";
                                //button1.paddingLeft = "90%";
                                imageButton.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
                                imageButton.color = "white";
                                imageButton.fontSize = 16;
                                imageButton.background = "green";
                                imageButton.paddingTop = "1%";
                                imageButton.paddingBottom = "5%";
                                imageButton.paddingLeft = "10%";
                                imageButton.onPointerUpObservable.add(function () {
                                    //alert("you did it!");
                                    //console.log(grid)
                                    /*
                                    if (grid.isVisible == false) {
                                        grid.isVisible = true;
                                    } else {
                                        grid.isVisible = false;
                                    }
                                    */
                                    if (SVImage.isVisible == false) {
                                        SVImage.isVisible = true;
                                    } else {
                                        SVImage.isVisible = false;
                                    }
                                    /*
                                    if (sv.isVisible == false) {
                                        sv.isVisible = true;
                                    } else {
                                        sv.isVisible = false;
                                    }
                                    */
                                    //console.log(sv)
                                    //sv.isVisible = false;
                                });

                                sv.addControl(tb)
                                sv.addControl(imageButton)
                            
                                //anno_map.plane = plane;
                                anno_map.sv = sv;
                                anno_list.push(anno_map)
                            }
                            for (const anno of anno_list) {
                                console.log(anno)
                                var button = BABYLON.MeshBuilder.CreateCylinder("button", { radius: 0.5, height: 0.2 }, scene)

                                button.position.y = objectPosition.y + anno.position.y;
                                button.position.x = objectPosition.x + anno.position.x;
                                button.position.z = objectPosition.z + anno.position.z;
                                //button.position.y = mesh.absolutePosition.y + anno.position.y;
                                //button.position.x = mesh.absolutePosition.x + anno.position.x;
                                //button.position.z = mesh.absolutePosition.z + anno.position.z;

                                //button.scaling.x = anno.scale.x;
                                //button.scaling.y = anno.scale.y;
                                //button.scaling.z = anno.scale.z;
                                button.scaling.x = mesh.scaling.x;
                                button.scaling.y = mesh.scaling.y;
                                button.scaling.z = mesh.scaling.z;
                                button.rotation.y = Math.PI / 1;
                                button.rotation.x = Math.PI / -2;
                                button.rotation.z = Math.PI / 1;
                                button.setParent(mesh)

                                button.material = new BABYLON.StandardMaterial("mat_button", scene);
                                //button.material.diffuseColor = BABYLON.Color3.Random();
                                button.material.diffuseTexture = new BABYLON.Texture("./textures/comment.png");
                                //button.material.diffuseTexture = new BABYLON.Texture("https://jo-fil-ho.com/babylonJS/comment.png");

                                // add actionManager on each cyl
                                button.actionManager = new BABYLON.ActionManager(scene);
                                // register 'pickCylinder' as the handler function for cylinder picking action.
                                button.actionManager.registerAction(
                                    new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickTrigger, function () {
                                        /*
                                        if (anno.plane.isVisible === false){
                                            anno.plane.isVisible = true;
                                            anno.sv.isVisible = true;
                                        }else{
                                            anno.plane.isVisible = false;
                                            anno.sv.isVisible = false;
                                        }
                                        */

                                        if (anno.sv.isVisible === false) {
                                            anno.sv.isVisible = true;
                                        } else {
                                            anno.sv.isVisible = false;
                                        }

                                    })
                                );
                            }



                            const data_list = []

                            for (const datum of data) {

                                var makeCard = function (item, itemDetail, positionObject, detailCardPosition) {


                                    var makeDetailCard = function (positionObject) {

                                        var sv = new BABYLON.GUI.ScrollViewer();
                                        sv.thickness = 8;
                                        sv.color = "gray";
                                        //sv.width = 1;
                                        //sv.height = 1;
                                        sv.width = 0.8;
                                        sv.height = 0.6;
                                        sv.background = "white";
                                        sv.isVisible = false;

                                        advancedTextureDetail.addControl(sv);

                                        const info_list = []
                                        const itemDetailKeys = Object.keys(itemDetail)
                                        for (let i = 0; i < itemDetailKeys.length; i++) {
                                            const paddingTopParam = 5 + i * 10
                                            console.log(paddingTopParam)

                                            const key = itemDetailKeys[i]

                                            var Info = new BABYLON.GUI.TextBlock();
                                            Info.fontFamily = "Tahoma, sans-serif";
                                            Info.text = key + ": " + itemDetail[key];
                                            Info.textWrapping = true;
                                            Info.color = "black";
                                            Info.fontSize = 30;
                                            Info.resizeToFit = true;
                                            Info.paddingTop = String(paddingTopParam) + "%";
                                            Info.paddingLeft = "30px";
                                            Info.paddingRight = "20px";
                                            Info.paddingBottom = "5%";
                                            Info.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
                                            Info.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
                                            Info.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
                                            Info.textVerticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
                                            Info.isVisible = false;

                                            //metaInfoTextBlock = metaInfo;

                                            sv.addControl(Info);
                                            info_list.push(Info)
                                        }
                                        console.log(info_list)

                                        //return { uiInfo: [detailCard, detailPlane, sv], metaInfo: info_list }
                                        return { uiInfo: [sv], metaInfo: info_list }
                                    }

                                    const detailCards = makeDetailCard(datum.positionObject)

                                    var makeSVImage = function () {
                                        var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");

                                        var SVImgae = new BABYLON.GUI.ScrollViewer();
                                        SVImgae.width = "800px";
                                        SVImgae.height = "500px";
                                        SVImgae.background = "white";
                                        SVImgae.isVisible = false;

                                        advancedTexture.addControl(SVImgae);

                                        var gd = new BABYLON.GUI.Grid();
                                        gd.width = "600px";
                                        const rowNumber = datum.itemImage.length + 1;
                                        console.log(rowNumber)
                                        gd.height = String(rowNumber * 300) + "px";
                                        gd.paddingTop = "15%";
                                        //gd.addColumnDefinition(1 / 3);
                                        //gd.addColumnDefinition(1 / 3);
                                        //gd.addColumnDefinition(1 / 3);
                                        gd.addColumnDefinition(3 / 4);
                                        gd.addColumnDefinition(1 / 4);
                                        /*
                                        for (let i = 0; i < parseInt((datum.itemImage.length + 1) / 3) + 1; i++) {
                                            console.log(parseInt((datum.itemImage.length + 1) / 3) + 1)
                                            gd.addRowDefinition(1 / (parseInt((datum.itemImage.length + 1) / 3) + 1));
                                        };
                                        */
                                        if (datum.itemImage.length !== 0) {
                                            for (let i = 0; i < datum.itemImage.length + 1; i++) {
                                                gd.addRowDefinition(1 / datum.itemImage.length + 1);
                                            };
                                        } else {
                                            gd.addRowDefinition(1 / 1);
                                        };
                                        /*
                                        if (anno.contentImage.length !== 0) {
                                            for (let i = 0; i < anno.contentImage.length+1/2; i++) {
                                                grid.addColumnDefinition(1 / anno.contentImage.length+1%2);
                                                //grid.addRowDefinition(0.5);
                                                //grid.addRowDefinition(0.5);
                                            }
                                        } else {
                                            grid.addColumnDefinition(1 / 1);
                                        };
                                        */
                                        SVImgae.addControl(gd);

                                        let backButton = BABYLON.GUI.Button.CreateSimpleButton("but1", "Back");
                                        backButton.width = "100px";
                                        backButton.height = "50px";
                                        backButton.color = "black";
                                        backButton.background = "black";
                                        //button1.paddingLeft = "90%";
                                        backButton.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
                                        backButton.color = "white";
                                        backButton.fontSize = 16;
                                        backButton.onPointerUpObservable.add(function () {
                                            //alert("you did it!");
                                            console.log(gd)
                                            if (SVImage.isVisible == false) {
                                                SVImage.isVisible = true;
                                            } else {
                                                SVImage.isVisible = false;
                                            }
                                            /*
                                            if (sv.isVisible == false) {
                                                sv.isVisible = true;
                                            } else {
                                                sv.isVisible = false;
                                            }
                                            */
                                        });
                                        gd.addControl(backButton, 0, 0)

                                        if (datum.itemImage.length !== 0) {
                                    
                                            for (const [index, value] of datum.itemImage.entries()) {
                                                console.log([index, value])

                                                var image = new BABYLON.GUI.Image("but", value["item"]);
                                                //image.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
                                                image.width = 0.9;
                                                image.height = 0.9;
                                                image.populateNinePatchSlicesFromImage = true;
                                                //image.stretch = BABYLON.GUI.Image.STRETCH_NINE_PATCH;
                                                image.stretch = BABYLON.GUI.Image.STRETCH_UNIFORM;

                                                var text = new BABYLON.GUI.TextBlock();
                                                text.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
                                                text.text = "Hello!";

                                                gd.addControl(image, index + 1, 0);
                                                gd.addControl(text, index + 1, 1);
                                                console.log(index + 1);

                                            }
                                        } else {
                                            var text = new BABYLON.GUI.TextBlock();
                                            text.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
                                            text.text = "No Image!";
                                            gd.addControl(text, 0, 1)
                                        };

                                        return SVImgae;
                                    };

                                    const SVImage = makeSVImage();


                                    let card = BABYLON.MeshBuilder.CreateBox("box", { height: 1, width: 2, depth: 0.2 });
                                    card.position = new BABYLON.Vector3(objectPosition.x + positionObject.x, objectPosition.y + positionObject.y, objectPosition.z + positionObject.z);
                                    //card.scaling.x = 0.1;
                                    //card.scaling.y = 0.1;
                                    //card.scaling.z = 0.05;
                                    card.scaling.x = mesh.scaling.x * 2;
                                    card.scaling.y = mesh.scaling.y * 2.5;
                                    card.scaling.z = mesh.scaling.z;
                                    card.background = "white",
                                        card.thickness = 1;
                                    //card.rotation = new BABYLON.Vector3(0, -0.5, 0);
                                    card.setParent(mesh)

                                    /*
                                    var sv = new BABYLON.GUI.ScrollViewer();
                                        sv.thickness = 8;
                                        sv.color = "gray";
                                        //sv.width = 1;
                                        //sv.height = 1;
                                        sv.width = 0.8;
                                        sv.height = 0.6;
                                        sv.background = "white";
                                    */

                                    let plane = BABYLON.MeshBuilder.CreatePlane("plane", { height: 1, width: 2 });
                                    plane.background = "",
                                        plane.parent = card;
                                    //plane.parent = sv;
                                    plane.position.z = -0.11;

                                    var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateForMesh(plane);
                                    //advancedTextureDetail.addControl(sv);

                                    let panel = new BABYLON.GUI.StackPanel();
                                    panel.verticalAlignment = 0;

                                    advancedTexture.addControl(panel);

                                    let title = new BABYLON.GUI.TextBlock(item.title);
                                    title.text = item.title;
                                    title.color = "black";
                                    title.fontSize = 120;
                                    title.height = "200px";
                                    title.textHorizontalAlignment = 0;
                                    title.textVerticalAlignment = 0;
                                    title.paddingTop = "5%";
                                    title.paddingButtom = 2;
                                    title.paddingLeft = 40;
                                    title.paddingRight = 40;
                                    panel.addControl(title);
                                    advancedTexture.addControl(title);

                                    let date = new BABYLON.GUI.TextBlock();
                                    date.text = item.year;
                                    date.color = "black";
                                    date.fontSize = 100;
                                    date.height = "200px";
                                    date.textHorizontalAlignment = 0;
                                    date.textVerticalAlignment = 0;
                                    date.paddingTop = "5%";
                                    date.paddingLeft = 40;
                                    date.paddingRight = 40;
                                    panel.addControl(date);
                                    advancedTexture.addControl(date);

                                    let note = new BABYLON.GUI.TextBlock();
                                    note.fontFamily = "Tahoma, sans-serif";
                                    note.text = item.author;
                                    note.textWrapping = true;
                                    note.color = "black";
                                    note.fontSize = 100;
                                    note.height = "200px";
                                    note.textHorizontalAlignment = 0;
                                    note.textVerticalAlignment = 0;
                                    note.paddingTop = "5%";
                                    note.paddingLeft = 40;
                                    note.paddingRight = 40;
                                    panel.addControl(note);
                                    advancedTexture.addControl(note);

                                    let button1 = BABYLON.GUI.Button.CreateSimpleButton("but1", "Text");
                                    button1.width = 0.4;
                                    button1.height = "200px";
                                    button1.color = "white";
                                    button1.fontSize = 100;
                                    button1.background = "green";
                                    button1.paddingTop = "1%";
                                    button1.paddingBottom = "5%";
                                    button1.paddingLeft = "10%";
                                    //button1.paddingRight = 70;
                                    button1.onPointerUpObservable.add(function () {
                                        //alert("you did it!");

                                        for (const detailCard of detailCards.uiInfo) {

                                            console.log(detailCard)

                                            if (detailCard.isVisible == false) {
                                                detailCard.isVisible = true;
                                            } else {
                                                detailCard.isVisible = false;
                                            }

                                            for (const info of detailCards.metaInfo) {
                                                if (info.isVisible == false) {
                                                    info.isVisible = true;
                                                } else {
                                                    info.isVisible = false;
                                                }
                                            }

                                        }
                                    });
                                    button1.verticalAlignment = 1;
                                    button1.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
                                    advancedTexture.addControl(button1);

                                    let button2 = BABYLON.GUI.Button.CreateSimpleButton("but2", "Image");
                                    button2.width = 0.45;
                                    button2.height = "200px";
                                    button2.color = "white";
                                    button2.fontSize = 100;
                                    button2.background = "green";
                                    button2.paddingTop = "1%";
                                    button2.paddingBottom = "5%";
                                    //button2.paddingLeft = 10;
                                    button2.paddingRight = "10%";
                                    button2.onPointerUpObservable.add(function () {
                                        //alert("you did it!");
                                        //console.log(grid)
                                        /*
                                        if (grid.isVisible == false) {
                                            grid.isVisible = true;
                                        } else {
                                            grid.isVisible = false;
                                        }
                                        */

                                        if (SVImage.isVisible == false) {
                                            SVImage.isVisible = true;
                                        } else {
                                            SVImage.isVisible = false;
                                        }

                                    });
                                    button2.verticalAlignment = 1;
                                    button2.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
                                    advancedTexture.addControl(button2);

                                    card.isVisible = false;
                                    plane.isVisible = false;
                                    title.isVisible = false;
                                    date.isVisible = false;
                                    note.isVisible = false;
                                    panel.isVisible = false;
                                    button1.isVisible = false;
                                    button2.isVisible = false;

                                    return [card, plane, title, date, note, panel, button1, button2];
                                    //return [card,title,date,panel,button1];


                                }

                                const showCards = makeCard(datum.item, datum.itemDetail, datum.positionObject, detailCardPosition)
                                data_list.push(showCards)
                            }


                            var buttonInfo = BABYLON.MeshBuilder.CreateCylinder("button_4", { radius: 0.5, height: 0.2 }, scene)

                            //buttonInfo.position.y = metaData.buttonPosition.y;
                            buttonInfo.position.y = objectPosition.y + metaData.buttonPosition.y;
                            buttonInfo.position.x = objectPosition.x + metaData.buttonPosition.x;
                            buttonInfo.position.z = objectPosition.z + metaData.buttonPosition.z;
                            buttonInfo.scaling.y = 0.05;
                            buttonInfo.scaling.x = 0.05;
                            buttonInfo.scaling.z = 0.05;
                            buttonInfo.rotation.y = Math.PI / 1;
                            buttonInfo.rotation.x = Math.PI / -2;
                            buttonInfo.rotation.z = Math.PI / 1;
                            buttonInfo.setParent(mesh)

                            buttonInfo.material = new BABYLON.StandardMaterial("mat_buttonInfo", scene);
                            buttonInfo.material.diffuseTexture = new BABYLON.Texture("./textures/info.png");
                            //buttonInfo.material.diffuseTexture = new BABYLON.Texture("https://jo-fil-ho.com/babylonJS/info.png");

                            // add actionManager on each cyl
                            buttonInfo.actionManager = new BABYLON.ActionManager(scene);
                            // register 'pickCylinder' as the handler function for cylinder picking action.
                            buttonInfo.actionManager.registerAction(
                                new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickTrigger, function () {

                                    for (const data of data_list) {
                                        for (const showCard of data) {
                                            if (showCard.isVisible == false) {
                                                showCard.isVisible = true;
                                                data[1].position.z = -0.12;
                                            } else {
                                                showCard.isVisible = false;
                                                data[1].position.z = -0.11;
                                            }
                                        }
                                    }
                                })
                            );
                        }
                    });
            };

            console.log(listMeshes)

            //信憑性に基づく色付けをセレクトボックスで行う！
            for (const mesh of listMeshes) {
                console.log(mesh)
                const meshMaterial = new BABYLON.StandardMaterial("material", scene);

                const typeA = function (isChecked) {
                    if (isChecked) {
                        if (mesh.type === "A") {
                            meshMaterial.diffuseColor = new BABYLON.Color3(255, 0, 0);
                            meshMaterial.alpha = 0.5;
                            mesh.material = meshMaterial;
                        } else {
                            ;
                        };
                    }
                    else {
                        ;
                    }
                }

                const typeB = function (isChecked) {
                    if (isChecked) {
                        if (mesh.type === "B") {
                            meshMaterial.diffuseColor = new BABYLON.Color3(0, 255, 0);
                            meshMaterial.alpha = 0.5;
                            mesh.material = meshMaterial;
                        } else {
                            ;
                        };
                    }
                    else {
                        ;
                    }
                }

                const typeC = function (isChecked) {
                    if (isChecked) {
                        if (mesh.type === "C") {
                            meshMaterial.diffuseColor = new BABYLON.Color3(255, 255, 0);
                            meshMaterial.alpha = 0.5;
                            mesh.material = meshMaterial;
                        } else {
                            ;
                        };
                    }
                    else {
                        ;
                    }
                }

                var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");

                var selectBox = new BABYLON.GUI.SelectionPanel("sp");
                selectBox.width = 0.15;
                selectBox.height = 0.2;
                selectBox.background = "#FFFF99";
                selectBox.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
                selectBox.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;

                advancedTexture.addControl(selectBox);

                var transformGroup = new BABYLON.GUI.CheckboxGroup("Transformation");

                transformGroup.addCheckbox("typeA", typeA);
                transformGroup.addCheckbox("typeB", typeB);
                transformGroup.addCheckbox("typeC", typeC);


                selectBox.addGroup(transformGroup);
            }


            var anchor = new BABYLON.AbstractMesh("anchor", scene);

            // Create the 3D UI manager
            var manager = new BABYLON.GUI.GUI3DManager(scene);

            var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");


            // テクスチャ生成(prefix を指定すれば自動で6枚読んでくれる)
            const skyTexture = new BABYLON.CubeTexture("https://www.babylonjs-playground.com/textures/skybox", scene);

            // マテリアル生成
            const skyMaterial = new BABYLON.StandardMaterial("cube_mat", scene);
            skyMaterial.reflectionTexture = skyTexture;
            skyMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE; // テクスチャを skybox 用にする
            skyMaterial.disableLighting = true; // ライティングを無視する
            skyMaterial.backFaceCulling = false; // 背面も表示する

            // メッシュ生成
            const skyMesh = BABYLON.MeshBuilder.CreateBox("cube_mesh", { size: 1000 }, scene);
            skyMesh.infiniteDistance = true; // カメラからの距離に依存しないメッシュとみなす
            skyMesh.material = skyMaterial;



            const ground = BABYLON.MeshBuilder.CreateGround("ground", { width: 500, height: 500 });
            //ground.position.y = 0.2;

            /*
            const ground2 = BABYLON.MeshBuilder.CreateGround("ground2", { width: 14.8, height: 14.8 });
            ground2.position.y = 1.2;
            */


            const groundMat = new BABYLON.StandardMaterial("groundMat");
            groundMat.diffuseTexture = new BABYLON.Texture("https://www.babylonjs-playground.com/textures/floor.png");
            groundMat.diffuseTexture.uScale = 100;
            groundMat.diffuseTexture.vScale = 100;
            //groundMat.diffuseTexture = new BABYLON.Texture("inscription1/KB3D_REM_StonePortuguese_basecolor.png");

            ground.material = groundMat;
            console.log(ground,/*ground2*/)

            //listMeshes.push(ground);

            // webXRの場合はこちら
            var defaultXRExperience = scene.createDefaultXRExperienceAsync({
                //xrInput: defaultXRExperience.input,  
                //floorMeshes: [ground] //Array of meshes to be used as landing points 
                floorMeshes: [ground,listMeshes]
            });
            // defaultXRExperience.teleportation.addFloorMesh(ground);
            // defaultXRExperience.pointerSelection.attach();

            /*
                        const featuresManager = defaultXRExperience.baseExperience.featuresManager;
                        const handTracking = featuresManager.enableFeature(BABYLON.WebXRFeatureName.HAND_TRACKING, "latest", {
                            xrInput: defaultXRExperienc.input
                        });
            */

            // GUI
            //const advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");

            // Style
            var style = advancedTexture.createStyle();
            style.fontSize = 24;
            style.fontStyle = "bold";

            return scene;

            /*  
            const xrPromise = scene.createDefaultXRExperienceAsync({
                floorMeshes: [ground]
            });
            return xrPromise.then((xrExperience) => {
                console.log("Done, WebXR is enabled.");
                return scene;
            });
            */
        };

        const scene = createScene(); // Call the createScene function

        /*
        console.log(scene.meshes.length)
        for (var k = 0; k < scene.meshes.length; k++) {
            var mesh = scene.meshes[k]
            console.log(mesh.name)
        }
        */

        // Register a render loop to repeatedly render the scene
        engine.runRenderLoop(function () {
            scene.render();
        });

        // Watch for browser/canvas resize events
        window.addEventListener("resize", function () {
            engine.resize();
        });

        /*
        createScene().then(sceneToRender => {
            engine.runRenderLoop(() => sceneToRender.render());
        });
        */
    </script>
</body>

</html>